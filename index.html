<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ë‚´ ë‹¨ì–´ì¥ (ë³´ì•ˆ+ë¡œê·¸ì¸+ë™ê¸°í™”)</title>
  <style>
    :root{
      --bg:#0b1020; --text:#f4f7ff; --muted:#b8c0ff;
      --accent:#6aa9ff; --ok:#5bffb0; --danger:#ff6a6a;
      --wordSize: 46px; --meaningSize: 26px; --exampleSize: 28px; --uiSize: 18px;
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 10%, #1a2a66 0%, var(--bg) 55%) fixed;
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Noto Sans KR","Noto Sans",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 18px 16px 28px;
    }
    .wrap{ max-width: 980px; margin: 0 auto; }
    header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:8px 2px 12px;}
    .title{font-size:22px;font-weight:1000;letter-spacing:-0.4px;line-height:1.15;}
    .sub{font-size:14px;color:var(--muted);margin-top:4px;line-height:1.25;max-width:76ch;}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:10px 12px;border-radius:999px;
      font-size:var(--uiSize);
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      user-select:none;-webkit-tap-highlight-color:transparent;
    }
    .pill button{
      all:unset;cursor:pointer;padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      font-weight:950;
    }
    .pill button:active{transform:scale(.98);}

    .panel{
      margin-top:14px;border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      padding:14px;
    }
    .panel h3{margin:0 0 10px 0;font-size:18px;letter-spacing:-0.4px;}
    label{font-size:14px;color:rgba(244,247,255,.8);font-weight:950;display:block;margin-bottom:6px;}
    input,textarea,select{
      width:100%;
      border-radius:14px;border:1px solid rgba(255,255,255,.16);
      background: rgba(17,26,51,.55);
      color:var(--text);
      padding:14px 14px;font-size:18px;outline:none;
    }
    textarea{min-height:92px;resize:vertical;}
    .grid{display:grid;grid-template-columns:1fr;gap:10px;}
    @media (min-width: 820px){ .grid.two{grid-template-columns:1fr 1fr;} }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn,.chip{
      all:unset;cursor:pointer;
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      font-size:var(--uiSize);font-weight:1000;
      user-select:none;-webkit-tap-highlight-color:transparent;
    }
    .btn.primary{background:rgba(106,169,255,.18);border-color:rgba(106,169,255,.38);}
    .btn.ok{background:rgba(91,255,176,.14);border-color:rgba(91,255,176,.34);}
    .btn.danger{background:rgba(255,106,106,.12);border-color:rgba(255,106,106,.34);}
    .chip[aria-pressed="true"]{background:rgba(106,169,255,.18);border-color:rgba(106,169,255,.38);}
    .btn:active,.chip:active{transform:scale(.99);}
    .note{font-size:13px;color:rgba(244,247,255,.72);line-height:1.35;margin-top:10px;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;}

    .cardArea{margin-top:12px;perspective:1400px;touch-action:pan-y;}
    
    .card{
      position:relative;width:100%;
      height:min(62vh,520px);min-height:420px;
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      overflow:hidden;
      will-change: transform;
    }
    .side{
      position:absolute;inset:0;padding:22px 20px;
      display:flex;flex-direction:column;justify-content:center;gap:16px;
      user-select:none;-webkit-tap-highlight-color:transparent;
    }
    .front{background: linear-gradient(180deg, rgba(106,169,255,.14), rgba(17,26,51,.05));}
    .back{background: linear-gradient(180deg, rgba(91,255,176,.12), rgba(17,26,51,.05));}
    .side.hiddenSide{display:none;}
.hint{
      position:absolute;top:14px;left:16px;right:16px;
      font-size:14px;color:rgba(244,247,255,.75);
      display:flex;justify-content:space-between;gap:10px;line-height:1.2;
    }
    .badge{
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      font-weight:1000;white-space:nowrap;
    }
    .big{text-align:center;font-weight:1100;letter-spacing:-0.7px;font-size:var(--wordSize);line-height:1.08;padding:10px 6px;word-break:keep-all;}
    .meaning{text-align:center;font-size:var(--meaningSize);line-height:1.25;color:rgba(244,247,255,.92);padding:0 10px;min-height:40px;}
    .meaning.hidden{visibility:hidden;}
    .example{text-align:center;font-size:var(--exampleSize);line-height:1.25;font-weight:1100;padding:0 10px;word-break:keep-all;}
    .controls{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;}
    .progress{font-size:var(--uiSize);font-weight:1100;color:rgba(244,247,255,.92);}
    .stats{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px;}
    .stat{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:14px;font-weight:1000;}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.18);
      padding:10px 14px;border-radius:999px;font-size:14px;color:var(--text);
      opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:50;
    }
    .toast.show{opacity:1;}
    details{margin-top:14px;border-radius:var(--radius);border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:12px 14px;}
    summary{cursor:pointer;font-weight:1100;font-size:18px;-webkit-tap-highlight-color:transparent;}
    pre{white-space:pre-wrap}
  
  /* ğŸ”¥ í´ë¦­ ë¬´ë°˜ì‘ ë°©ì§€: ë²„íŠ¼ ìœ„ì— ë ˆì´ì–´ê°€ ë®ì—¬ë„ í´ë¦­ë˜ê²Œ ê°•ì œ */
  #btnLoginGoogle{position:relative;z-index:999999;pointer-events:auto !important;}
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">ë‚´ê°€ ë§Œë“œëŠ” ë‹¨ì–´ì¥ (ë³´ì•ˆ + ë¡œê·¸ì¸ + ë™ê¸°í™”)</div>
      <div class="sub">
        âœ… <b>ì˜ˆë¬¸(ë’·ë©´)ì€ â€œë’¤ì§‘ê¸° ë²„íŠ¼â€ìœ¼ë¡œë§Œ í‘œì‹œ</b><br/>
        ì•ë©´: íƒ­=ë°œìŒ Â· ë”ë¸”íƒ­=ëœ» í‘œì‹œ/ìˆ¨ê¹€ Â· ì¢Œ/ìš° ìŠ¤ì™€ì´í”„=ì´ì „/ë‹¤ìŒ(ì¹´ë“œ ë’¤ì§‘í˜ ì—†ìŒ)<br/>
        + ê²€ìƒ‰/í•„í„° + ì¦ê²¨ì°¾ê¸° + ì˜¤ë‹µë…¸íŠ¸ + ìë™ ì €ì¥ + <b>Firebase(êµ¬ê¸€/ì• í”Œ ë¡œê·¸ì¸) ê¸°ë°˜ ì‹¤ì‹œê°„ ë™ê¸°í™”</b>
      </div>
    </div>
    <div class="pill">
      <span style="font-weight:1100;">ìŒì„±</span>
      <button id="btnStop">ì¤‘ì§€</button>
      <button id="btnSyncNow" title="ìˆ˜ë™ ì—…ë¡œë“œ">ë™ê¸°í™”</button>
    </div>
  </header>

  <section class="panel">
    <h3>ë¡œê·¸ì¸</h3>
    <div class="row">
      <div class="btnRow">
        <button class="btn primary" id="btnLoginGoogle" onclick="loginGoogle()">Googleë¡œ ë¡œê·¸ì¸</button>
        <button class="btn primary" id="btnLoginApple">Appleë¡œ ë¡œê·¸ì¸</button>
        <button class="btn" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <div class="mono" id="whoami">ë¡œê·¸ì¸: (ì•„ì§)</div>
    </div>
    <div class="note">
      âš ï¸ Apple ë¡œê·¸ì¸ì€ Firebaseì—ì„œ Apple provider í™œì„±í™” + Apple Developer OAuth ì„¤ì •ì´ í•„ìš”í•´(ì•„ë˜ ê°€ì´ë“œ ì°¸ê³ ).
    </div>
  </section>

  <section class="panel">
    <h3>ê²€ìƒ‰ / í•„í„°</h3>
    <div class="grid two">
      <div>
        <label for="searchBox">ê²€ìƒ‰ (ë‹¨ì–´/ëœ»/ì˜ˆë¬¸)</label>
        <input id="searchBox" placeholder="ì˜ˆ: yield / ê³µì • / improved ..." autocomplete="off" />
      </div>
      <div>
        <label>í•„í„°</label>
        <div class="btnRow" style="margin-top:2px;">
          <button class="chip" id="fAll" aria-pressed="true">ì „ì²´</button>
          <button class="chip" id="fFav" aria-pressed="false">ì¦ê²¨ì°¾ê¸°</button>
          <button class="chip" id="fWrong" aria-pressed="false">ì˜¤ë‹µë…¸íŠ¸</button>
          <button class="chip" id="fDue" aria-pressed="false">ë³µìŠµí•„ìš”</button>
        </div>
      </div>
    </div>
  </section>

  <section class="cardArea" aria-label="ë‹¨ì–´ ì¹´ë“œ ì˜ì—­">
    <div id="card" class="card" aria-live="polite">
      <div class="side front" id="frontSide">
        <div class="hint">
          <span class="badge">ì•ë©´</span>
          <span class="badge">íƒ­: ë°œìŒ Â· ë”ë¸”íƒ­: ëœ»</span>
        </div>
        <div class="big" id="wordText">ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì¤˜</div>
        <div class="meaning hidden" id="meaningText">ëœ»</div>

        <div class="stats">
          <span class="stat" id="sFav">â˜† ì¦ê²¨ì°¾ê¸°: -</span>
          <span class="stat" id="sWrong">ì˜¤ë‹µ: -</span>
          <span class="stat" id="sDue">ë³µìŠµ: -</span>
          <span class="stat" id="sSync">ë™ê¸°í™”: OFF</span>
        </div>

        <div class="note" style="text-align:center;margin-top:6px;">
          (ì•ë©´ íƒ­=ë‹¨ì–´ ì½ê¸° / ë¹ ë¥´ê²Œ 2ë²ˆ íƒ­=ëœ» í‘œì‹œ)
        </div>
      </div>

      <div class="side back hiddenSide" id="backSide">
        <div class="hint">
          <span class="badge">ë’·ë©´</span>
          <span class="badge">íƒ­: ì˜ˆë¬¸ ì½ê¸°</span>
        </div>
        <div class="example" id="exampleText">ì˜ˆë¬¸ì„ ì¶”ê°€í•´ì¤˜</div>
        <div class="note" style="text-align:center;margin-top:6px;">
          (ë’·ë©´ ì˜ˆë¬¸ íƒ­=ë¬¸ì¥ ì½ê¸°)
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="btnRow">
        <button class="btn" id="btnPrev">â† ì´ì „</button>
        <button class="btn primary" id="btnFlip">ë’¤ì§‘ê¸°</button>
        <button class="btn" id="btnNext">ë‹¤ìŒ â†’</button>
      </div>
      <div class="btnRow">
        <button class="btn" id="btnToggleFav">â˜† ì¦ê²¨ì°¾ê¸°</button>
        <button class="btn danger" id="btnMarkWrong">í‹€ë¦¼</button>
        <button class="btn ok" id="btnMarkRight">ì •ë‹µ ì²˜ë¦¬</button>
        <div class="progress" id="progress">0 / 0</div>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>ë‹¨ì–´ ì¶”ê°€ / í¸ì§‘</h3>
    <div class="grid">
      <div>
        <label for="inWord">ë‹¨ì–´</label>
        <input id="inWord" placeholder="ì˜ˆ: yield / äº§é‡ / ì•Œê³ ë¦¬ì¦˜" autocomplete="off" />
      </div>
      <div>
        <label for="inMeaning">ëœ»(í•œê¸€)</label>
        <input id="inMeaning" placeholder="ì˜ˆ: ìˆ˜ìœ¨, ìƒì‚°ëŸ‰..." autocomplete="off" />
      </div>
      <div>
        <label for="inExample">ì˜ˆë¬¸</label>
        <textarea id="inExample" placeholder="ì˜ˆ: The yield improved after process tuning."></textarea>
      </div>
      <div>
        <label for="inLang">ì½ê¸° ì–¸ì–´(TTS)</label>
        <select id="inLang">
          <option value="en-US">ì˜ì–´ (en-US)</option>
          <option value="ko-KR">í•œêµ­ì–´ (ko-KR)</option>
          <option value="zh-CN">ì¤‘êµ­ì–´ (zh-CN)</option>
          <option value="ja-JP">ì¼ë³¸ì–´ (ja-JP)</option>
          <option value="de-DE">ë…ì¼ì–´ (de-DE)</option>
          <option value="fr-FR">í”„ë‘ìŠ¤ì–´ (fr-FR)</option>
          <option value="es-ES">ìŠ¤í˜ì¸ì–´ (es-ES)</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div class="btnRow">
        <button class="btn primary" id="btnAdd">+ ì¶”ê°€</button>
        <button class="btn" id="btnLoad">í˜„ì¬ ì¹´ë“œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button class="btn" id="btnUpdate">í˜„ì¬ ì¹´ë“œ ìˆ˜ì •</button>
        <button class="btn danger" id="btnDelete">í˜„ì¬ ì¹´ë“œ ì‚­ì œ</button>
      </div>
      <div class="btnRow">
        <button class="btn" id="btnExport">ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <button class="btn" id="btnImport">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
        <button class="btn danger" id="btnReset">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </section>

  <details open>
    <summary>ë™ê¸°í™” ì„¤ì • (ë³´ì•ˆ ê°•í™” + ë¡œê·¸ì¸ í•„ìš”)</summary>
    <div class="note" style="margin-top:10px;">
      âœ… ì´ ë²„ì „ì€ <b>ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ</b> ë±ì„ ì½ê³ /ì“¸ ìˆ˜ ìˆê²Œ ì„¤ê³„ë˜ì–´ ìˆì–´.<br/>
      - ë± ìƒì„±/ìˆ˜ì •: <b>ì†Œìœ ì(owner)ë§Œ ê°€ëŠ¥</b><br/>
      - ë± ê³µìœ : ì†Œìœ ìê°€ <b>ìƒëŒ€ UID</b>ë¥¼ readersì— ì¶”ê°€í•˜ë©´ <b>ì½ê¸°(ì‹¤ì‹œê°„ ë³´ê¸°)</b> ê°€ëŠ¥<br/>
      <br/>
      1) Firebase ì½˜ì†” â†’ í”„ë¡œì íŠ¸ ìƒì„± â†’ Firestore Database ìƒì„±<br/>
      2) Authentication â†’ Sign-in method â†’ <b>Google</b>, <b>Apple</b> í™œì„±í™”<br/>
      3) ì•„ë˜ì— firebaseConfig(JSON) ë¶™ì—¬ë„£ê¸°<br/>
      4) Deck Code ì…ë ¥ â†’ â€œë™ê¸°í™” ì—°ê²°â€
    </div>

    <div class="grid two" style="margin-top:10px;">
      <div>
        <label for="deckCode">Deck Code (ë¬¸ì„œ ID)</label>
        <input id="deckCode" placeholder="ì˜ˆ: mydeck-2026" autocomplete="off" />
      </div>
      <div>
        <label for="syncMode">ë™ê¸°í™” ë°©ì‹</label>
        <select id="syncMode">
          <option value="realtime">ì‹¤ì‹œê°„(ê¶Œì¥)</option>
          <option value="manual">ìˆ˜ë™(ë²„íŠ¼ ì—…ë¡œë“œ)</option>
        </select>
      </div>
    </div>

    <div class="grid" style="margin-top:10px;">
      <div>
        <label for="firebaseConfig">firebaseConfig(JSON)</label>
        <textarea id="firebaseConfig" placeholder='ì˜ˆ: { "apiKey": "...", "authDomain": "...", "projectId": "...", ... }'></textarea>
      </div>
    </div>

    <div class="btnRow" style="margin-top:10px;">
      <button class="btn primary" id="btnConnect">ë™ê¸°í™” ì—°ê²°</button>
      <button class="btn" id="btnDisconnect">ì—°ê²° í•´ì œ</button>
      <button class="btn danger" id="btnClearSync">ì„¤ì • ì§€ìš°ê¸°</button>
    </div>

    <div class="note mono" id="syncStatus" style="margin-top:10px;">ë™ê¸°í™”: OFF</div>

    <details>
      <summary>ë± ê³µìœ (ì½ê¸° ì „ìš©) - ìƒëŒ€ UID ì¶”ê°€</summary>
      <div class="note" style="margin-top:10px;">
        ìƒëŒ€ë°©ì´ ë¡œê·¸ì¸í•˜ë©´ í™”ë©´ ìƒë‹¨ â€œwhoamiâ€ì— UIDê°€ ë³´ì—¬. ê·¸ UIDë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê³  ì¶”ê°€í•´ì¤˜.
        (ë³´ì•ˆ ê·œì¹™ìƒ <b>ì†Œìœ ìë§Œ</b> readersë¥¼ ìˆ˜ì • ê°€ëŠ¥)
      </div>
      <div class="grid two" style="margin-top:10px;">
        <div>
          <label for="shareUid">ìƒëŒ€ UID</label>
          <input id="shareUid" placeholder="ì˜ˆ: 7hG...abc" autocomplete="off" />
        </div>
        <div class="btnRow" style="align-self:end;">
          <button class="btn primary" id="btnAddReader">readersì— ì¶”ê°€</button>
          <button class="btn danger" id="btnRemoveReader">readersì—ì„œ ì œê±°</button>
        </div>
      </div>
    </details>

    <details>
      <summary>Firestore ë³´ì•ˆ ê·œì¹™(ê¶Œì¥ ìƒ˜í”Œ)</summary>
      <div class="note" style="margin-top:10px;">
        ì•„ë˜ ê·œì¹™ì€ <b>ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ ì ‘ê·¼</b> ê°€ëŠ¥ + <b>ownerë§Œ write</b> + <b>readersëŠ” readë§Œ</b> í—ˆìš©.
      </div>
      <pre class="mono" style="background:rgba(0,0,0,.25);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /vocab_decks/{deckCode} {
      function isSignedIn() { return request.auth != null; }
      function isOwner() { return isSignedIn() && resource.data.ownerUid == request.auth.uid; }
      function isReader() { return isSignedIn() && (request.auth.uid in (resource.data.readers)); }

      allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
      allow read: if isOwner() || isReader();
      allow update, delete: if isOwner();
    }
  }
}</pre>
    </details>

    <details>
      <summary>Apple ë¡œê·¸ì¸ ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸(í•„ìˆ˜)</summary>
      <div class="note" style="margin-top:10px;">
        Appleì€ â€œì¼œê¸°â€ë§Œìœ¼ë¡œ ëì´ ì•„ë‹ˆë¼, Apple Developerì—ì„œ OAuth ì„¤ì •ì´ í•„ìš”í•´.<br/>
        - Apple Developer Program ê°€ì… í•„ìš”(ìœ ë£Œ)<br/>
        - Service ID(ì›¹ OAuth) ìƒì„± + Sign in with Apple í™œì„±í™”<br/>
        - Redirect URL ë“±ë¡<br/>
        - Firebase Authentication Apple Providerì— Service ID / Team ID / Key ID / Private Key ë“±ë¡<br/>
        - Authorized domainsì— ì‚¬ìš© ë„ë©”ì¸ ì¶”ê°€<br/><br/>
        â€» Apple/Google ë¡œê·¸ì¸ì€ ë³´í†µ <b>https ë„ë©”ì¸</b>ì—ì„œ ê°€ì¥ ì•ˆì •ì ì´ì•¼(ì˜ˆ: GitHub Pages).
      </div>
    </details>
  </details>

</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
(() => {
  const STORAGE_KEY = "my_vocab_deck_secure_v1";
  const SYNC_KEY = "my_vocab_sync_secure_v1";
  const DE
  const DEFAULT_FIREBASE_CONFIG_TEXT = '{\n  "apiKey": "AIzaSyDfaDzzVVnSZT1iOu3DizjC8wyHkc3Clx8",\n  "authDomain": "vocabulary-97ec2.firebaseapp.com",\n  "projectId": "vocabulary-97ec2",\n  "storageBucket": "vocabulary-97ec2.firebasestorage.app",\n  "messagingSenderId": "468601038998",\n  "appId": "1:468601038998:web:f646add36d6a5e1ed43ab7"\n}';

  // ===== DEBUG HELPERS =====
  const DEBUG_ENABLED = true;
  function dbg(msg, obj){
    if(!DEBUG_ENABLED) return;
    try{
      const t = new Date().toLocaleTimeString();
      const el = document.getElementById("debugLog");
      if(!el) return;
      let line = `[${t}] ${msg}`;
      if(obj !== undefined){
        try{ line += "\n" + JSON.stringify(obj, null, 2); }catch(e){}
      }
      el.textContent = line + "\n\n" + el.textContent;
      console.log("DBG:", msg, obj ?? "");
    }catch(e){}
  }
VICE_ID_KEY = "my_vocab_device_id_secure_v1";

  const $ = (id) => document.getElementById(id);

  const card = $("card");
  const frontSide = $("frontSide");
  const backSide = $("backSide");
  const wordText = $("wordText");
  const meaningText = $("meaningText");
  const exampleText = $("exampleText");
  const progress = $("progress");
  const toast = $("toast");

  const sFav = $("sFav");
  const sWrong = $("sWrong");
  const sDue = $("sDue");
  const sSync = $("sSync");

  const searchBox = $("searchBox");
  const fAll = $("fAll");
  const fFav = $("fFav");
  const fWrong = $("fWrong");
  const fDue = $("fDue");

  const inWord = $("inWord");
  const inMeaning = $("inMeaning");
  const inExample = $("inExample");
  const inLang = $("inLang");

  const btnPrev = $("btnPrev");
  const btnNext = $("btnNext");
  const btnFlip = $("btnFlip");
  const btnStop = $("btnStop");
  const btnSyncNow = $("btnSyncNow");

  const btnToggleFav = $("btnToggleFav");
  const btnMarkWrong = $("btnMarkWrong");
  const btnMarkRight = $("btnMarkRight");

  const btnAdd = $("btnAdd");
  const btnLoad = $("btnLoad");
  const btnUpdate = $("btnUpdate");
  const btnDelete = $("btnDelete");
  const btnReset = $("btnReset");
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");

  const btnLoginGoogle = $("btnLoginGoogle");
  const btnLoginApple = $("btnLoginApple");
  const btnLogout = $("btnLogout");
  const whoami = $("whoami");

  const deckCodeEl = $("deckCode");
  const firebaseConfigEl = $("firebaseConfig");
  const syncModeEl = $("syncMode");
  const btnConnect = $("btnConnect");
  const btnDisconnect = $("btnDisconnect");
  const btnClearSync = $("btnClearSync");
  const syncStatusEl = $("syncStatus");

  const shareUidEl = $("shareUid");
  const btnAddReader = $("btnAddReader");
  const btnRemoveReader = $("btnRemoveReader");

  function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

  const SAMPLE = [
    { id: uid(), word:"yield", meaning:"ìˆ˜ìœ¨", example:"The yield improved after process tuning.", lang:"en-US", favorite:false, wrongCount:0, needsReview:false, createdAt:Date.now(), updatedAt:Date.now() },
    { id: uid(), word:"å·¥è‰º", meaning:"ê³µì •", example:"è¿™é“å·¥è‰ºå¯ä»¥æé«˜è‰¯ç‡ã€‚", lang:"zh-CN", favorite:true, wrongCount:1, needsReview:true, createdAt:Date.now(), updatedAt:Date.now() },
  ];

  let deck = loadDeck();
  let filterMode = "all";
  let view = [];
  let viewPos = 0;

  let lastTapAt = 0;
  const DOUBLE_TAP_MS = 350;

  let touchStartX=null, touchStartY=null;

  const deviceId = getOrCreateDeviceId();

  let sync = loadSyncSettings(); // {deckCode, firebaseConfigText, mode}
  if(!sync.firebaseConfigText || !sync.firebaseConfigText.trim()){
    sync.firebaseConfigText = DEFAULT_FIREBASE_CONFIG_TEXT;
    try{ localStorage.setItem(SYNC_KEY, JSON.stringify(sync)); }catch(e){}
  }
  let firebaseApp=null, auth=null, firestore=null;
  let unsub=null;
  let suppressRemoteApply=false;
  let lastLocalPushedAt=0;
  let syncTimer=null;

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1200);
  }

  function normalizeDeck(arr){
    const now = Date.now();
    return (arr||[]).map(x => ({
      id: (x.id ?? uid()).toString(),
      word: (x.word ?? "").toString(),
      meaning: (x.meaning ?? "").toString(),
      example: (x.example ?? "").toString(),
      lang: (x.lang ?? "en-US").toString(),
      favorite: !!x.favorite,
      wrongCount: Number.isFinite(+x.wrongCount) ? +x.wrongCount : 0,
      needsReview: !!x.needsReview,
      createdAt: Number.isFinite(+x.createdAt) ? +x.createdAt : now,
      updatedAt: Number.isFinite(+x.updatedAt) ? +x.updatedAt : now,
    }));
  }

  function loadDeck(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(SAMPLE));
        return [...SAMPLE];
      }
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed)) return normalizeDeck(parsed);
    }catch(e){}
    localStorage.setItem(STORAGE_KEY, JSON.stringify(SAMPLE));
    return [...SAMPLE];
  }

  function saveDeck(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(deck)); }

  function getOrCreateDeviceId(){
    let id = localStorage.getItem(DEVICE_ID_KEY);
    if(!id){ id = "dev-" + uid(); localStorage.setItem(DEVICE_ID_KEY, id); }
    return id;
  }

  function loadSyncSettings(){
    try{
      const raw = localStorage.getItem(SYNC_KEY);
      if(!raw) return { deckCode:"", firebaseConfigText:DEFAULT_FIREBASE_CONFIG_TEXT, mode:"realtime" };
      const p = JSON.parse(raw);
      return {
        deckCode: (p.deckCode ?? "").toString(),
        firebaseConfigText: (p.firebaseConfigText ?? "").toString(),
        mode: (p.mode==="manual") ? "manual" : "realtime",
      };
    }catch(e){
      return { deckCode:"", firebaseConfigText:DEFAULT_FIREBASE_CONFIG_TEXT, mode:"realtime" };
    }
  }

  function saveSyncSettings(){ localStorage.setItem(SYNC_KEY, JSON.stringify(sync)); }

  function currentCard(){ return (view.length===0) ? null : (view[viewPos] || null); }

  function recomputeView(keepCurrent=true){
    const curId = keepCurrent ? (currentCard()?.id ?? null) : null;
    const q = (searchBox.value || "").trim().toLowerCase();

    const pred = (c) => {
      const hay = `${c.word} ${c.meaning} ${c.example}`.toLowerCase();
      if(q && !hay.includes(q)) return false;
      if(filterMode==="fav") return c.favorite;
      if(filterMode==="wrong") return c.wrongCount > 0;
      if(filterMode==="due") return c.needsReview === true;
      return true;
    };

    view = deck.filter(pred);

    if(view.length===0){
      viewPos = 0;
      render();
      return;
    }

    if(curId){
      const np = view.findIndex(x=>x.id===curId);
      viewPos = (np>=0) ? np : Math.min(viewPos, view.length-1);
    }else{
      viewPos = Math.min(viewPos, view.length-1);
    }
    render();
  }

  function render(){
    const conn = isConnected() ? `ON (${sync.mode==="manual"?"ìˆ˜ë™":"ì‹¤ì‹œê°„"})` : "OFF";
    sSync.textContent = `ë™ê¸°í™”: ${conn}`;

    if(view.length===0){
      wordText.textContent = "í‘œì‹œí•  ì¹´ë“œê°€ ì—†ì–´";
      meaningText.textContent = "ê²€ìƒ‰/í•„í„°ë¥¼ ë°”ê¾¸ê±°ë‚˜ ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ì¤˜";
      exampleText.textContent = "ì˜ˆë¬¸";
      progress.textContent = "0 / 0";
      sFav.textContent = "â˜† ì¦ê²¨ì°¾ê¸°: -";
      sWrong.textContent = "ì˜¤ë‹µ: -";
      sDue.textContent = "ë³µìŠµ: -";
      meaningText.classList.remove("hidden");
      backSide.classList.add("hiddenSide");
      frontSide.classList.remove("hiddenSide");
      return;
    }

    const c = currentCard();
    wordText.textContent = c.word || "(ë‹¨ì–´ ì—†ìŒ)";
    meaningText.textContent = c.meaning || "(ëœ» ì—†ìŒ)";
    exampleText.textContent = c.example || "(ì˜ˆë¬¸ ì—†ìŒ)";
    progress.textContent = `${viewPos + 1} / ${view.length}`;

    sFav.textContent = c.favorite ? "â˜… ì¦ê²¨ì°¾ê¸°: ON" : "â˜† ì¦ê²¨ì°¾ê¸°: OFF";
    sWrong.textContent = `ì˜¤ë‹µ: ${c.wrongCount}`;
    sDue.textContent = `ë³µìŠµ: ${c.needsReview ? "í•„ìš”" : "ì™„ë£Œ"}`;

    meaningText.classList.add("hidden");
  }

  function speak(text, lang){
    if(!text) return;
    if(!("speechSynthesis" in window)){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” TTS(Web Speech API)ë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„."); return; }
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || "en-US";
    const voices = window.speechSynthesis.getVoices?.() || [];
    const match = voices.find(v => (v.lang||"").toLowerCase() === (u.lang||"").toLowerCase());
    if(match) u.voice = match;
    window.speechSynthesis.speak(u);
  }
  function stopSpeak(){ if("speechSynthesis" in window) window.speechSynthesis.cancel(); }

  function toggleMeaning(){ meaningText.classList.toggle("hidden"); }

  function flip(){
    // âœ… iOS/ëª¨ë°”ì¼ ì•ˆì •: 3D backface ë Œë”ë§ ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´
    // "íšŒì „ ì• ë‹ˆë©”ì´ì…˜(0â†’90)" í›„ ë©´ì„ êµì²´í•˜ê³  "(-90â†’0)"ë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.
    const backIsHidden = backSide.classList.contains("hiddenSide");
    const goingToBack = backIsHidden; // í˜„ì¬ ì•ë©´ì´ë©´ ë’·ë©´ìœ¼ë¡œ ê°„ë‹¤

    // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ ì¤‘ë³µ í´ë¦­ ë°©ì§€
    if(card.dataset.animating === "1") return;
    card.dataset.animating = "1";

    const first = card.animate(
      [{ transform:"rotateY(0deg)" }, { transform:"rotateY(90deg)" }],
      { duration: 180, easing:"ease-in", fill:"forwards" }
    );

    first.onfinish = () => {
      // ë©´ êµì²´ (ì´ ì‹œì ì— ì¹´ë“œê°€ ì˜†ë©´ì´ë¼ í‹°ê°€ ê±°ì˜ ì•ˆ ë‚¨)
      if(goingToBack){
        frontSide.classList.add("hiddenSide");
        backSide.classList.remove("hiddenSide");
      }else{
        backSide.classList.add("hiddenSide");
        frontSide.classList.remove("hiddenSide");
      }
      meaningText.classList.add("hidden");

      const second = card.animate(
        [{ transform:"rotateY(-90deg)" }, { transform:"rotateY(0deg)" }],
        { duration: 220, easing:"ease-out", fill:"forwards" }
      );
      second.onfinish = () => {
        card.style.transform = "rotateY(0deg)";
        card.dataset.animating = "0";
      };
    };
  }

  function prev(){
    if(view.length===0) return;
    viewPos = (viewPos-1+view.length)%view.length;
    backSide.classList.add("hiddenSide");
    frontSide.classList.remove("hiddenSide");
    meaningText.classList.add("hidden");
    render();
  }

  function next(){
    if(view.length===0) return;
    viewPos = (viewPos+1)%view.length;
    backSide.classList.add("hiddenSide");
    frontSide.classList.remove("hiddenSide");
    meaningText.classList.add("hidden");
    render();
  }

  function findDeckIndexById(id){ return deck.findIndex(x=>x.id===id); }

  function touchChanged(){
    saveDeck();
    recomputeView(true);
    queueSyncPush();
  }

  function toggleFavorite(){
    const c = currentCard(); if(!c) return;
    const i = findDeckIndexById(c.id); if(i<0) return;
    deck[i].favorite = !deck[i].favorite;
    deck[i].updatedAt = Date.now();
    touchChanged();
    showToast(deck[i].favorite ? "ì¦ê²¨ì°¾ê¸° ON" : "ì¦ê²¨ì°¾ê¸° OFF");
  }

  function markWrong(){
    const c = currentCard(); if(!c) return;
    const i = findDeckIndexById(c.id); if(i<0) return;
    deck[i].wrongCount = (deck[i].wrongCount||0) + 1;
    deck[i].needsReview = true;
    deck[i].updatedAt = Date.now();
    touchChanged();
    showToast("ì˜¤ë‹µ +1");
  }

  function markRight(){
    const c = currentCard(); if(!c) return;
    const i = findDeckIndexById(c.id); if(i<0) return;
    deck[i].needsReview = false;
    deck[i].updatedAt = Date.now();
    touchChanged();
    showToast("ì •ë‹µ ì²˜ë¦¬");
  }

  function addCard(){
    const word = (inWord.value||"").trim();
    const meaning = (inMeaning.value||"").trim();
    const example = (inExample.value||"").trim();
    const lang = (inLang.value||"en-US").trim();
    if(!word){ showToast("ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì¤˜"); inWord.focus(); return; }

    const now = Date.now();
    const obj = { id: uid(), word, meaning, example, lang, favorite:false, wrongCount:0, needsReview:false, createdAt:now, updatedAt:now };
    deck.push(obj);
    saveDeck();
    recomputeView(false);
    const np = view.findIndex(x=>x.id===obj.id);
    if(np>=0) viewPos = np;

    inWord.value=""; inMeaning.value=""; inExample.value="";
    backSide.classList.add("hiddenSide");
    frontSide.classList.remove("hiddenSide");
    meaningText.classList.add("hidden");
    render();
    showToast("ì¶”ê°€ ì™„ë£Œ!");
    queueSyncPush();
  }

  function loadCurrentIntoInputs(){
    const c = currentCard(); if(!c){ showToast("ë¶ˆëŸ¬ì˜¬ ì¹´ë“œê°€ ì—†ì–´"); return; }
    inWord.value = c.word || "";
    inMeaning.value = c.meaning || "";
    inExample.value = c.example || "";
    inLang.value = c.lang || "en-US";
    showToast("í˜„ì¬ ì¹´ë“œ ë¶ˆëŸ¬ì˜´");
  }

  function updateCurrentFromInputs(){
    const c = currentCard(); if(!c){ showToast("ìˆ˜ì •í•  ì¹´ë“œê°€ ì—†ì–´"); return; }
    const i = findDeckIndexById(c.id); if(i<0) return;

    const word = (inWord.value||"").trim();
    if(!word){ showToast("ë‹¨ì–´ëŠ” ë¹„ìš¸ ìˆ˜ ì—†ì–´"); return; }

    deck[i].word = word;
    deck[i].meaning = (inMeaning.value||"").trim();
    deck[i].example = (inExample.value||"").trim();
    deck[i].lang = (inLang.value||"en-US").trim();
    deck[i].updatedAt = Date.now();
    touchChanged();
    showToast("ìˆ˜ì • ì™„ë£Œ!");
  }

  function deleteCurrent(){
    const c = currentCard(); if(!c) return;
    if(!confirm(`"${c.word}" ì¹´ë“œë¥¼ ì‚­ì œí• ê¹Œ?`)) return;
    const i = findDeckIndexById(c.id); if(i<0) return;
    deck.splice(i,1);
    saveDeck();
    recomputeView(false);
    viewPos = Math.min(viewPos, Math.max(view.length-1,0));
    render();
    showToast("ì‚­ì œ ì™„ë£Œ");
    queueSyncPush();
  }

  function resetAll(){
    if(!confirm("ì •ë§ ì „ì²´ ë‹¨ì–´ì¥ì„ ì´ˆê¸°í™”í• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)")) return;
    deck = [];
    saveDeck();
    recomputeView(false);
    showToast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
    queueSyncPush();
  }

  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); return true; }catch(e){ return false; }
  }

  function exportJSON(){
    const data = JSON.stringify(deck, null, 2);
    copyToClipboard(data).then(ok => ok ? showToast("JSON ë³µì‚¬ ì™„ë£Œ!") : prompt("ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•´ ì €ì¥í•´ì¤˜:", data));
  }

  function importJSON(){
    const raw = prompt("ê°€ì ¸ì˜¬ JSONì„ ë¶™ì—¬ë„£ì–´ì¤˜:");
    if(!raw) return;
    try{
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) throw new Error("not array");
      deck = normalizeDeck(parsed);
      saveDeck();
      recomputeView(false);
      showToast("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
      queueSyncPush();
    }catch(e){
      alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.");
    }
  }

  function setFilter(mode){
    filterMode = mode;
    [fAll,fFav,fWrong,fDue].forEach(b => b.setAttribute("aria-pressed","false"));
    if(mode==="all") fAll.setAttribute("aria-pressed","true");
    if(mode==="fav") fFav.setAttribute("aria-pressed","true");
    if(mode==="wrong") fWrong.setAttribute("aria-pressed","true");
    if(mode==="due") fDue.setAttribute("aria-pressed","true");
    recomputeView(true);
  }

  function setSyncStatus(t){ syncStatusEl.textContent = t; }

  function canInitFirebase(){ return !!sync.firebaseConfigText; }

  function ensureFirebase(){
    if(firebaseApp) return true;
    if(!canInitFirebase()){ showToast("firebaseConfig í•„ìš”"); return false; }
    try{
      const cfg = JSON.parse(sync.firebaseConfigText);
      firebaseApp = firebase.initializeApp(cfg);
      auth = firebase.auth(firebaseApp);
      firestore = firebase.firestore(firebaseApp);
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
      return true;
    }catch(e){
      alert("firebaseConfig JSONì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„.");
      return false;
    }
  }


  function isIOS(){
    const ua = navigator.userAgent || "";
    return /iPad|iPhone|iPod/.test(ua) || (navigator.platform==="MacIntel" && navigator.maxTouchPoints>1);
  }

  async function handleRedirectResultIfAny(){
    if(!ensureFirebase()) return;
    try{
      const res = await auth.getRedirectResult();
      if(res && res.user){
        showToast("ë¡œê·¸ì¸ ì™„ë£Œ");
      }
    }catch(e){
      // ignore but log
      console.warn("getRedirectResult error:", e);
    }
  }

  function isLoggedIn(){ return !!(auth && auth.currentUser); }
  function isConnected(){ return !!(firestore && unsub && sync.deckCode); }

  function deckDoc(){ return firestore.collection("vocab_decks").doc(sync.deckCode); }

  function stopListening(){
    if(unsub){ try{unsub();}catch(e){} unsub=null; }
  }

  async function pushNow(reason="manual"){
    if(!ensureFirebase()) return;
    if(!isLoggedIn()){ showToast("ë¡œê·¸ì¸ í•„ìš”"); return; }
    if(!sync.deckCode){ showToast("Deck Code í•„ìš”"); return; }

    const updatedAt = Date.now();
    lastLocalPushedAt = updatedAt;

    const uidNow = auth.currentUser.uid;

    try{
      const snap = await deckDoc().get();
      if(!snap.exists){
        await deckDoc().set({
          ownerUid: uidNow,
          readers: [],
          deck,
          updatedAt,
          deviceId,
          reason
        }, { merge:false });
      }else{
        await deckDoc().set({ deck, updatedAt, deviceId, reason }, { merge:true });
      }
      setSyncStatus(`ë™ê¸°í™”: ON (${sync.mode==="manual"?"ìˆ˜ë™":"ì‹¤ì‹œê°„"}) Â· ì—…ë¡œë“œ: ${new Date(updatedAt).toLocaleString()}`);
      showToast("ë™ê¸°í™” ì™„ë£Œ");
    }catch(e){
      console.error(e);
      setSyncStatus("ë™ê¸°í™”: ERROR (ê¶Œí•œ/ë„¤íŠ¸ì›Œí¬/owner ì•„ë‹˜?)");
      showToast("ë™ê¸°í™” ì‹¤íŒ¨");
    }
  }

  function startListening(){
    if(!ensureFirebase()) return;
    if(!isLoggedIn()){ showToast("ë¡œê·¸ì¸ í•„ìš”"); return; }
    if(!sync.deckCode){ showToast("Deck Code í•„ìš”"); return; }

    stopListening();
    setSyncStatus("ë™ê¸°í™”: ON (ì—°ê²° ì¤‘...)");

    unsub = deckDoc().onSnapshot((snap)=>{
      if(!snap.exists){
        setSyncStatus("ë™ê¸°í™”: ON (ë¬¸ì„œ ì—†ìŒ - ë™ê¸°í™” ë²„íŠ¼ìœ¼ë¡œ ìƒì„±)");
        return;
      }
      const data = snap.data() || {};
      const remoteUpdatedAt = data.updatedAt || 0;
      const remoteDeviceId = data.deviceId || "";

      if(remoteDeviceId === deviceId && remoteUpdatedAt <= lastLocalPushedAt) return;

      const remoteDeck = Array.isArray(data.deck) ? normalizeDeck(data.deck) : [];
      const localMax = deck.reduce((m,c)=>Math.max(m, c.updatedAt||0), 0);

      if(remoteUpdatedAt > localMax){
        suppressRemoteApply = true;
        deck = remoteDeck;
        saveDeck();
        recomputeView(true);
        suppressRemoteApply = false;
        showToast("ì›ê²© ë³€ê²½ ë°˜ì˜");
      }

      setSyncStatus(`ë™ê¸°í™”: ON (${sync.mode==="manual"?"ìˆ˜ë™":"ì‹¤ì‹œê°„"}) Â· ì›ê²©: ${new Date(remoteUpdatedAt).toLocaleString()}`);
    }, (err)=>{
      console.error(err);
      setSyncStatus("ë™ê¸°í™”: ERROR (ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ)");
    });
  }

  function queueSyncPush(){
    if(suppressRemoteApply) return;
    if(!ensureFirebase()) return;
    if(!isLoggedIn()) return;
    if(!sync.deckCode) return;
    if(sync.mode !== "realtime") return;
    clearTimeout(syncTimer);
    syncTimer = setTimeout(()=>pushNow("auto"), 650);
  }

  async function connect(){
    sync.deckCode = (deckCodeEl.value||"").trim();
    sync.firebaseConfigText = (firebaseConfigEl.value||"").trim();
    sync.mode = (syncModeEl.value==="manual") ? "manual" : "realtime";
    saveSyncSettings();

    if(!ensureFirebase()) return;
    if(!isLoggedIn()){ showToast("ë¨¼ì € ë¡œê·¸ì¸"); return; }
    startListening();
    setSyncStatus("ë™ê¸°í™”: ON (ì—°ê²°ë¨) Â· í•„ìš” ì‹œ ë™ê¸°í™” ë²„íŠ¼ìœ¼ë¡œ ì—…ë¡œë“œ");
    recomputeView(true);
  }

  function disconnect(){
    stopListening();
    setSyncStatus("ë™ê¸°í™”: OFF");

  const btnClearDebug = document.getElementById("btnClearDebug");
  if(btnClearDebug){ btnClearDebug.addEventListener("click", ()=>{ const dl=document.getElementById("debugLog"); if(dl) dl.textContent=""; }); }

  dbg("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ", {url: location.href, ua: navigator.userAgent});

  // Redirect ë¡œê·¸ì¸ ë³µê·€ ì²˜ë¦¬
  handleRedirectResultIfAny();
    showToast("ì—°ê²° í•´ì œ");
    recomputeView(true);
  }

  function clearSync(){
    if(!confirm("firebaseConfig / Deck Code ì„¤ì •ì„ ì´ ê¸°ê¸°ì—ì„œ ì§€ìš¸ê¹Œ?")) return;
    disconnect();
    sync = { deckCode:"", firebaseConfigText:"", mode:"realtime" };
    saveSyncSettings();
    deckCodeEl.value = "";
    firebaseConfigEl.value = "";
    syncModeEl.value = "realtime";
    showToast("ì„¤ì • ì‚­ì œ");
  }

  async function addReader(){
    if(!ensureFirebase()) return;
    if(!isLoggedIn()) { showToast("ë¡œê·¸ì¸ í•„ìš”"); return; }
    const uidToAdd = (shareUidEl.value||"").trim();
    if(!uidToAdd){ showToast("ìƒëŒ€ UID í•„ìš”"); return; }
    if(!sync.deckCode){ showToast("Deck Code í•„ìš”"); return; }

    try{
      await deckDoc().set({ readers: firebase.firestore.FieldValue.arrayUnion(uidToAdd) }, { merge:true });
      showToast("readers ì¶”ê°€ ì™„ë£Œ");
    }catch(e){
      console.error(e);
      showToast("ì¶”ê°€ ì‹¤íŒ¨(ê¶Œí•œ/owner?)");
    }
  }

  async function removeReader(){
    if(!ensureFirebase()) return;
    if(!isLoggedIn()) { showToast("ë¡œê·¸ì¸ í•„ìš”"); return; }
    const uidToRemove = (shareUidEl.value||"").trim();
    if(!uidToRemove){ showToast("ìƒëŒ€ UID í•„ìš”"); return; }
    if(!sync.deckCode){ showToast("Deck Code í•„ìš”"); return; }

    try{
      await deckDoc().set({ readers: firebase.firestore.FieldValue.arrayRemove(uidToRemove) }, { merge:true });
      showToast("readers ì œê±° ì™„ë£Œ");
    }catch(e){
      console.error(e);
      showToast("ì œê±° ì‹¤íŒ¨(ê¶Œí•œ/owner?)");
    }
  }

  function refreshWhoami(){
    if(!ensureFirebase()){
      whoami.textContent = "ë¡œê·¸ì¸: (firebaseConfig í•„ìš”)";
      return;
    }
    const u = auth.currentUser;
    if(!u){ whoami.textContent = "ë¡œê·¸ì¸: (ì•„ì§)"; return; }
    whoami.textContent = `ë¡œê·¸ì¸: ${u.providerData?.[0]?.providerId || "user"} | UID: ${u.uid}`;
  }

  async function loginGoogle(){
    dbg("loginGoogle() í´ë¦­ë¨");
    if(!ensureFirebase()){
      dbg("ensureFirebase() ì‹¤íŒ¨");
      return;
    }
    dbg("ensureFirebase() ì„±ê³µ", {hasAuth: !!auth, hasFirestore: !!firestore});

    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      dbg("GoogleAuthProvider ìƒì„± OK");

      if(isIOS()){
        dbg("iOS ê°ì§€ â†’ signInWithRedirect ì‹œì‘");
        await auth.signInWithRedirect(provider);
        dbg("signInWithRedirect í˜¸ì¶œë¨ (ì •ìƒì´ë¼ë©´ í™”ë©´ ì´ë™)");
        return;
      }

      dbg("Desktop â†’ signInWithPopup ì‹œì‘");
      await auth.signInWithPopup(provider);
      dbg("signInWithPopup ì„±ê³µ", {uid: auth.currentUser?.uid || null});
      showToast("Google ë¡œê·¸ì¸ ì™„ë£Œ");
    }catch(e){
      dbg("loginGoogle ì˜ˆì™¸", {code: e?.code, message: e?.message, name: e?.name});
      console.error(e);

      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        dbg("popup ì‹¤íŒ¨ â†’ redirect ì¬ì‹œë„");
        await auth.signInWithRedirect(provider);
        dbg("redirect ì¬ì‹œë„ í˜¸ì¶œë¨");
        return;
      }catch(e2){
        dbg("redirectë„ ì‹¤íŒ¨", {code: e2?.code, message: e2?.message, name: e2?.name});
        console.error(e2);
        showToast("ë¡œê·¸ì¸ ì‹¤íŒ¨ (íŒì—…/ë¦¬ë””ë ‰ì…˜ ëª¨ë‘ ì‹¤íŒ¨)");
      }
    }
  }

  // ì¸ë¼ì¸ onclickì—ì„œë„ í˜¸ì¶œë  ìˆ˜ ìˆê²Œ ì „ì—­ì— ë…¸ì¶œ
  window.loginGoogle = loginGoogle;
)();
</script>

  <!-- DEBUG PANEL -->
  <div id="debugPanel" style="position:fixed;left:12px;right:12px;bottom:12px;max-height:35vh;overflow:auto;
    background:rgba(0,0,0,0.85);color:#fff;padding:12px;border-radius:14px;z-index:9999999;font-size:12px;line-height:1.35;">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
      <b>DEBUG</b>
      <button id="btnClearDebug" style="background:#fff;color:#000;border:0;border-radius:10px;padding:6px 10px;font-weight:700;">
        Clear
      </button>
    </div>
    <div id="debugLog" style="margin-top:8px;white-space:pre-wrap;"></div>
  </div>

</body>
</html>
